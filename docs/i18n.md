# Internationalization (i18n) System

## Overview

The Chariot web application uses a comprehensive internationalization system built on [next-intl](https://next-intl-docs.vercel.app/) that provides:

- **Automatic locale detection** from browser preferences
- **Persistent user locale preference** across sessions
- **URL-based locale routing**
- **Seamless integration with Keycloak** authentication
- **Edge Runtime compatibility** for optimal performance
- **Namespace-based translation organization**

## Architecture

### Core Components

#### 1. Configuration Files

**`src/i18n/request.ts`**
- Main configuration file for next-intl
- Defines supported locales and default locale
- Loads translation messages for the current locale
- Compatible with Edge Runtime (no Node.js modules)

```typescript
export const locales = ["fr", "en", "es"] as const;
export const defaultLocale: Locale = "fr";
```

#### 2. Translation Files

**Location**: `/messages/{locale}.json`

Translations are organized in a single JSON file per locale with namespace-based structure:

```
messages/
├── en.json
├── es.json
└── fr.json
```

**Structure**:
```json
{
  "common": {
    "appName": "Chariot App",
    "appDescription": "Chariot Application"
  },
  "home": {
    "greeting": "Hello, Chariot!",
    "primary": "Primary"
  },
  "toast": {
    "success": "This is a success message.",
    "error": "This is an error message."
  }
}
```

#### 3. Middleware

**`src/middleware.ts`**
- Intercepts all requests to handle locale routing
- Detects user's preferred locale from cookies or Accept-Language header
- Redirects root URL to the appropriate locale (`/` → `/fr`)
- Ensures all routes include locale prefix

**Priority order for locale detection**:
1. User preference cookie (`user-preferred-locale`)
2. Browser Accept-Language header
3. Default locale (`fr`)

#### 4. Locale Preference Management

**`src/hooks/useLocalePreference.ts`**

Provides utilities to manage user locale preferences:

- `useLocalePreference()`: Hook for React components
- `detectBrowserLocale()`: Detects locale from browser settings
- `getStoredLocale()`: Retrieves saved locale from localStorage
- `saveStoredLocale()`: Saves locale to localStorage and cookie

**Storage**:
- **localStorage**: `user-preferred-locale` key
- **Cookie**: `user-preferred-locale` (expires in 365 days)

#### 5. Locale Detector

**`src/components/LocaleDetector.tsx`**

Client-side component that:
- Automatically detects browser locale on first visit
- Syncs current URL locale with user preferences
- Runs on every page load via root layout

## Usage

### In Components

#### Using Translations

```tsx
import { useTranslations } from "next-intl";

export default function MyComponent() {
  const t = useTranslations();

  return (
    <div>
      <h1>{t("home.greeting")}</h1>
      <p>{t("common.appDescription")}</p>
    </div>
  );
}
```

#### Accessing Current Locale

```tsx
import { useParams } from "next/navigation";

export default function MyComponent() {
  const params = useParams();
  const locale = params.locale as string; // "en", "fr", or "es"

  return <div>Current locale: {locale}</div>;
}
```

### In Server Components

```tsx
import { getTranslations } from "next-intl/server";

export default async function ServerComponent() {
  const t = await getTranslations();

  return <h1>{t("home.greeting")}</h1>;
}
```

## Translation Organization

### Namespace Strategy

Translations are organized by **namespace** to improve maintainability:

- **`common`**: Shared text across the application (app name, navigation, etc.)
- **`home`**: Home page specific translations
- **`toast`**: Toast notification messages
- **Additional namespaces**: Create as needed for different features/pages

### Adding New Translations

1. **Add keys to all locale files**:

```json
// messages/en.json
{
  "common": {
    "newKey": "New translation"
  }
}
```

2. **Use in components**:

```tsx
const t = useTranslations();
<span>{t("common.newKey")}</span>
```

### Best Practices

1. **Use namespaces**: Organize translations logically by feature/page
2. **Consistent keys**: Use same keys across all locales
3. **Descriptive names**: Use clear, self-documenting key names
4. **No hardcoded text**: All user-facing text should be translated
5. **Fallback**: Always provide translations for all supported locales

## Integration with Keycloak

The i18n system integrates seamlessly with Keycloak authentication:

**`src/providers/KeycloakProvider.tsx`**

- Passes user's preferred locale to Keycloak login/register flows
- Redirects new users to their browser-detected locale
- Maintains locale consistency across authentication flows

```typescript
// Login with user's preferred locale
keycloak.login({
  redirectUri: window.location.origin + `/${preferredLocale}`,
  locale: preferredLocale,
});
```

## URL Structure

All routes include a locale prefix:

- `/fr` → French homepage
- `/en/profile` → English profile page
- `/es/settings` → Spanish settings page

The middleware ensures this structure is maintained across the entire application.

## Supported Locales

Currently supported locales:

| Code | Language | Status |
|------|----------|--------|
| `fr` | Français | ✅ |
| `en` | English  | Default |
| `es` | Español  | ✅ |

### Adding New Locales

To add a new locale:

1. **Add locale to configuration**:

```typescript
// src/i18n/request.ts
export const locales = ["fr", "en", "es", "de"] as const;
```

2. **Create translation file**:

```bash
cp messages/en.json messages/de.json
# Translate content to German
```

3. **Update Keycloak realm** (if needed):
   - Add the locale to Keycloak realm internationalization settings

## Technical Details

### Edge Runtime Compatibility

The system is designed to work with Next.js Edge Runtime:

- No use of Node.js `fs` or `path` modules in runtime code
- Translation files are bundled at build time
- Middleware runs efficiently at the edge

### Performance Considerations

- **Translation files are cached**: Next.js bundles and caches translations
- **Middleware is lightweight**: Minimal processing for locale detection
- **Client-side persistence**: localStorage reduces server lookups

### Type Safety

TypeScript support for translations:

```typescript
export type Locale = "fr" | "en" | "es";
```

All locale strings are type-checked at compile time.

## Troubleshooting

### Issue: Translations not updating

**Solution**: Clear Next.js cache and rebuild
```bash
rm -rf .next
npm run build
```

### Issue: Wrong locale displayed

**Solution**: Check browser cookies and localStorage
```javascript
// Clear stored preference
localStorage.removeItem("user-preferred-locale");
document.cookie = "user-preferred-locale=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
```

### Issue: Middleware not detecting locale

**Solution**: Verify middleware matcher configuration
```typescript
export const config = {
  matcher: ["/((?!api|_next|.*\\..*).*)"],
};
```

## Migration Guide

### From single-locale to i18n

If migrating from a single-locale application:

1. Wrap all hardcoded text with `t()` calls
2. Extract strings to translation files
3. Update routing to include locale parameter
4. Test all routes with different locales

## References

- [next-intl Documentation](https://next-intl-docs.vercel.app/)
- [Next.js Internationalization](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
- [Keycloak Locale Documentation](https://www.keycloak.org/docs/latest/server_admin/#_user-locale)

## Maintainers

For questions or improvements to the i18n system, please contact the Chariot development team.
